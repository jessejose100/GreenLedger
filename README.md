GreenLedger
===========

Overview
--------

`GreenLedger` is a Clarity smart contract designed for the issuance, verification, and management of carbon credits on the Stacks blockchain. It incorporates AI oracle integration for verification and includes automated compliance and market analysis features to ensure the integrity and dynamic pricing of carbon credits. This contract aims to provide a transparent and efficient platform for carbon credit transactions, fostering environmental sustainability.

Features
--------

-   **Carbon Credit Issuance:** Allows authorized entities to issue new carbon credits with detailed metadata, amount, price, and expiry information.

-   **AI Oracle Registration:** Enables the contract owner to register and manage AI oracles responsible for verifying carbon credit projects.

-   **Project Registration:** Facilitates the registration of carbon reduction projects with details like owner, location, type, and estimated credits.

-   **AI-Powered Verification:** Integrates AI oracles to verify carbon credits based on provided data and confidence scores, updating the credit's status.

-   **Credit Transfer:** Allows users to transfer verified carbon credits between accounts.

-   **Automated Compliance & Market Analysis:** An AI-driven function that analyzes market data, environmental metrics, and regulatory scores to suggest dynamic pricing adjustments and determine compliance status.

-   **Balance Management:** Tracks user balances for each type of carbon credit.

Contract Details
----------------

### Constants

-   `contract-owner`: The principal address of the contract deployer, with elevated permissions.

-   `err-owner-only`: Error code for operations restricted to the contract owner.

-   `err-not-found`: Error code for when a specified ID (credit, oracle, or project) is not found.

-   `err-insufficient-balance`: Error code for insufficient carbon credit balance during transfers.

-   `err-invalid-amount`: Error code for invalid (e.g., zero or negative) amounts.

-   `err-not-verified`: Error code for operations requiring a verified credit.

-   `err-already-verified`: Error code when trying to verify an already verified credit.

-   `err-expired`: Error code for operations on expired carbon credits.

-   `err-unauthorized`: Error code for unauthorized access or actions.

-   `err-invalid-oracle`: Error code for invalid oracle related operations.

### Data Maps

-   `carbon-credits`: Stores details of each issued carbon credit, mapped by `credit-id`.

    -   `issuer`: Principal address of the credit issuer.

    -   `project-id`: Identifier for the associated project.

    -   `amount`: Total amount of carbon credits.

    -   `price-per-credit`: Price per single credit.

    -   `verification-status`: Current verification status (e.g., "pending", "verified", "rejected").

    -   `ai-confidence-score`: AI's confidence score from verification.

    -   `expiry-block`: Block height at which the credit expires.

    -   `metadata-hash`: Hash of external metadata related to the credit.

    -   `created-at`: Block height when the credit was created.

-   `user-balances`: Tracks the balance of specific carbon credits held by each user, mapped by `user` and `credit-id`.

    -   `balance`: The quantity of credits held.

-   `ai-oracles`: Stores information about registered AI oracles, mapped by `oracle-id`.

    -   `oracle-address`: Principal address of the AI oracle.

    -   `reputation-score`: Oracle's reputation score.

    -   `total-verifications`: Number of verifications performed by the oracle.

    -   `accuracy-rate`: Oracle's accuracy rate.

    -   `is-active`: Boolean indicating if the oracle is active.

-   `project-registry`: Stores details of registered carbon reduction projects, mapped by `project-id`.

    -   `owner`: Principal address of the project owner.

    -   `location`: Geographic location of the project.

    -   `project-type`: Type of the carbon reduction project.

    -   `estimated-credits`: Estimated carbon credits generated by the project.

    -   `verification-threshold`: Minimum AI confidence score required for verification.

    -   `is-active`: Boolean indicating if the project is active.

### Data Variables

-   `next-credit-id`: Tracks the next available ID for a new carbon credit.

-   `next-oracle-id`: Tracks the next available ID for a new AI oracle.

-   `total-credits-issued`: Keeps a running total of all carbon credits issued.

-   `verification-fee`: The fee required for credit verification (currently `u1000000` microSTX, equivalent to 1 STX).

### Private Functions

-   `(is-contract-owner)`: Checks if the `tx-sender` is the `contract-owner`.

-   `(calculate-ai-weighted-score (scores (list 10 uint)) (weights (list 10 uint)))`: Calculates a weighted average score from a list of scores and corresponding weights.

-   `(validate-credit-parameters (amount uint) (price uint) (expiry uint))`: Validates that credit `amount`, `price`, and `expiry` are positive and the expiry block is in the future.

-   `(list-length-10 (lst (list 10 uint)))`: Helper to return the length of a 10-element list (constant).

-   `(list-length-8 (lst (list 8 uint)))`: Helper to return the length of an 8-element list (constant).

-   `(list-length-5 (lst (list 5 uint)))`: Helper to return the length of a 5-element list (constant).

-   `(list-length-3 (lst (list 3 uint)))`: Helper to return the length of a 3-element list (constant).

-   `(abs-diff (a uint) (b uint))`: Calculates the absolute difference between two unsigned integers.

-   `(min-uint (a uint) (b uint))`: Returns the minimum of two unsigned integers.

-   `(calculate-market-volatility (market-data (list 10 uint)))`: Calculates market volatility based on deviations from a base value.

### Public Functions

-   `(register-ai-oracle (oracle-address principal) (initial-reputation uint))`:

    -   Registers a new AI oracle. Only callable by the `contract-owner`.

    -   Returns the new `oracle-id`.

-   `(register-project (project-id (string-ascii 64)) (location (string-ascii 100)) (project-type (string-ascii 50)) (estimated-credits uint))`:

    -   Registers a new carbon credit project.

    -   Sets the `tx-sender` as the project `owner`.

    -   Requires `estimated-credits` to be greater than 0.

    -   Returns `true` on success.

-   `(issue-carbon-credits (project-id (string-ascii 64)) (amount uint) (price-per-credit uint) (expiry-blocks uint) (metadata-hash (string-ascii 64)))`:

    -   Issues new carbon credits for a registered project.

    -   Transfers the newly issued credits to the issuer's balance.

    -   Updates `next-credit-id` and `total-credits-issued`.

    -   Returns the new `credit-id`.

-   `(ai-verify-credits (credit-id uint) (oracle-id uint) (verification-data (list 5 uint)) (confidence-score uint))`:

    -   Allows a registered AI oracle to verify a carbon credit.

    -   Updates the `verification-status` and `ai-confidence-score` of the credit based on weighted verification data and the provided confidence score.

    -   Updates the oracle's `total-verifications`.

    -   Returns the `final-confidence` score.

-   `(transfer-credits (credit-id uint) (recipient principal) (amount uint))`:

    -   Transfers a specified `amount` of a `credit-id` from `tx-sender` to `recipient`.

    -   Requires the credit to be "verified" and the sender to have sufficient balance.

    -   Returns `true` on success.

-   `(ai-automated-compliance-analysis (credit-id uint) (market-data (list 10 uint)) (environmental-metrics (list 8 uint)) (regulatory-scores (list 5 uint)))`:

    -   Performs an automated compliance and market analysis on a given `credit-id`.

    -   Calculates market volatility, environmental impact, and regulatory compliance scores.

    -   Suggests a dynamic `suggested-price` based on these metrics.

    -   Determines `is-compliant` status and generates a `recommendation-score`.

    -   Updates the `price-per-credit` and `ai-confidence-score` of the credit.

    -   Returns a tuple containing the comprehensive analysis results.

How to Use
----------

### Deployment

To deploy this contract, you will need a Clarity development environment (e.g., Stacks.js, Clarinet CLI).

1.  Save the contract code as a `.clar` file (e.g., `green-ledger.clar`).

2.  Use Clarinet or your preferred deployment method to deploy the contract to a Stacks blockchain. The `contract-owner` will automatically be set to the address that deploys the contract.

### Interaction Examples (Clarinet CLI)

```
# Assuming you have Clarinet installed and a testnet configured

# Register an AI oracle (as contract-owner)
clarinet call green-ledger register-ai-oracle 'ST000000000000000000002NHT7K2' u90 --sender ST1SJ3DTE5DN7X55JHPNCVPE9QJ62W1E52C140JJP --costs --is-owner

# Register a project
clarinet call green-ledger register-project '"ForestProtection001"' '"Amazon Rainforest"' '"Reforestation"' u1000 --sender ST1SJ3DTE5DN7X55JHPNCVPE9QJ62W1E52C140JJP

# Issue carbon credits for the project
clarinet call green-ledger issue-carbon-credits '"ForestProtection001"' u500 u2000000 u1000 '"hash123abc"' --sender ST1SJ3DTE5DN7X55JHPNCVPE9QJ62W1E52C140JJP

# AI Oracle verifies credits (as the registered oracle address)
clarinet call green-ledger ai-verify-credits u1 u1 '(list u80 u85 u70 u90 u75)' u88 --sender ST000000000000000000002NHT7K2

# Transfer credits
clarinet call green-ledger transfer-credits u1 'ST1XQ0X7E7P5G3E7R8W42E7T7K7M7R1Z7E1C7A7R7' u50 --sender ST1SJ3DTE5DN7X55JHPNCVPE9QJ62W1E52C140JJP

# Run automated compliance analysis
clarinet call green-ledger ai-automated-compliance-analysis u1 '(list u55 u52 u58 u60 u57 u50 u48 u53 u56 u51)' '(list u90 u85 u92 u88 u80 u75 u95 u87)' '(list u90 u85 u92 u88 u80)' --sender ST1SJ3DTE5DN7X55JHPNCVPE9QJ62W1E52C140JJP

```

Error Codes
-----------

-   `u100`: `err-owner-only` - Caller is not the contract owner.

-   `u101`: `err-not-found` - The specified credit, oracle, or project ID does not exist.

-   `u102`: `err-insufficient-balance` - Insufficient balance for the requested transfer.

-   `u103`: `err-invalid-amount` - The amount specified is invalid (e.g., zero or negative).

-   `u104`: `err-not-verified` - The carbon credit is not yet verified.

-   `u105`: `err-already-verified` - The carbon credit has already been verified.

-   `u106`: `err-expired` - The carbon credit has expired.

-   `u107`: `err-unauthorized` - The caller is not authorized for this action (e.g., not the oracle).

-   `u108`: `err-invalid-oracle` - The oracle specified is invalid or inactive.

Contributing
------------

Contributions are welcome! Please feel free to submit issues or pull requests. Before contributing, please:

1.  Fork the repository.

2.  Create a new branch for your feature or bug fix.

3.  Ensure your code adheres to Clarity best practices and is thoroughly tested.

4.  Submit a pull request with a clear description of your changes.

License
-------

This project is licensed under the MIT License - see the *LICENSE.md* file for details.

Future Enhancements
-------------------

-   **Decentralized Oracle Selection:** Implement a mechanism for decentralized selection and reputation management of AI oracles.

-   **Staking for Oracles:** Introduce staking requirements for AI oracles to incentivize honest behavior and penalize malicious actions.

-   **Governance Module:** Develop a governance module for community-driven updates and parameter changes.

-   **Tokenization of Carbon Credits:** Integrate a fungible token (FT) standard for seamless trading of carbon credits.

-   **Off-chain Data Integration:** Explore secure ways to integrate more complex off-chain data for verification and analysis.
